<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGo | Rider</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Your existing HTML structure -->
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCU_wJYBTwEwMZQ-iTYOjUZuEHEphA0DXc",
            authDomain: "easygo-10f4b.firebaseapp.com",
            projectId: "easygo-10f4b",
            storageBucket: "easygo-10f4b.firebasestorage.app",
            messagingSenderId: "197660067542",
            appId: "1:197660067542:web:6c616efb479b122f1f6b77",
            databaseURL: "https://easygo-10f4b-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        
        let database;
        let isFirebaseConnected = false;
        
        function initializeFirebase() {
            try {
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    isFirebaseConnected = snap.val() === true;
                });
            } catch (error) {
                console.error("Firebase error:", error);
            }
        }
        
        // Get available orders for rider
        async function getAvailableOrders() {
            if (!isFirebaseConnected) return [];
            
            try {
                const snapshot = await database.ref('orders')
                    .orderByChild('status')
                    .equalTo('ready-for-pickup')
                    .once('value');
                
                return snapshot.val() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
            } catch (error) {
                console.error("Error getting orders:", error);
                return [];
            }
        }
        
        // Rider accepts order
        async function acceptOrder(orderId, riderInfo) {
            if (!isFirebaseConnected) return false;
            
            try {
                await database.ref(`orders/${orderId}`).update({
                    status: 'accepted',
                    riderId: riderInfo.id,
                    riderName: riderInfo.name,
                    riderPhone: riderInfo.phone,
                    acceptedAt: Date.now()
                });
                return true;
            } catch (error) {
                console.error("Error accepting order:", error);
                return false;
            }
        }
        
        // Update delivery status
        async function updateDeliveryStatus(orderId, status, updateData = {}) {
            if (!isFirebaseConnected) return false;
            
            try {
                await database.ref(`orders/${orderId}`).update({
                    status: status,
                    deliveryUpdatedAt: Date.now(),
                    ...updateData
                });
                return true;
            } catch (error) {
                console.error("Error updating delivery:", error);
                return false;
            }
        }
        
        // Real-time order listener for rider
        function setupRiderOrderListener(riderId) {
            if (!isFirebaseConnected) return;
            
            // Listen for orders assigned to this rider
            database.ref('orders')
                .orderByChild('riderId')
                .equalTo(riderId)
                .on('value', function(snapshot) {
                    const orders = snapshot.val() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : [];
                    // Update rider UI
                    updateRiderOrders(orders);
                });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            
            // After rider login
            function loginDelivery() {
                // Your existing login logic
                const riderInfo = {
                    id: 'rider_' + Date.now(),
                    name: document.getElementById('delivery-partner-name').textContent,
                    phone: 'rider_phone' // Get from input
                };
                
                // Setup Firebase listeners
                if (isFirebaseConnected) {
                    setupRiderOrderListener(riderInfo.id);
                    loadAvailableOrders();
                }
            }
            
            // Load available orders
            async function loadAvailableOrders() {
                const orders = await getAvailableOrders();
                // Update your UI
                renderAvailableOrders(orders);
            }
        });
    </script>
</body>
</html>
